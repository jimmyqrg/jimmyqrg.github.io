<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>DB Export / Import</title>
<style>
  body { font-family: Arial; padding: 20px; background: #fafafa; color: #222; }
  h1 { font-size: 20px; }
  button { padding: 8px 14px; margin: 6px 0; }
  #log { background: #fff; border: 1px solid #ccc; padding: 10px; height: 240px; overflow-y: auto; font-size: 13px; }
  .filebox { margin-top: 10px; }
</style>
</head>
<body>

<h1>IndexedDB + LocalStorage Export / Import Test</h1>

<button id="exportBtn">Export (.jqrgd)</button>
<div class="filebox">
  <input type="file" id="importFile" accept=".jqrgd">
</div>
<button id="importBtn">Import</button>

<h2>Log</h2>
<div id="log"></div>

<script>
// -----------------------
// Logging helper
// -----------------------
function log(msg) {
  const el = document.getElementById("log");
  el.innerHTML += msg + "<br>";
  el.scrollTop = el.scrollHeight;
}

// -----------------------
// Export localStorage + IndexedDB
// -----------------------
async function exportAll() {
  log("Starting export…");

  const exportObj = { localStorage: {}, indexedDB: {} };

  // ---- LocalStorage ----
  log("Reading localStorage…");
  for (let i = 0; i < localStorage.length; i++) {
    const k = localStorage.key(i);
    exportObj.localStorage[k] = localStorage.getItem(k);
  }
  log("LocalStorage OK.");

  // ---- IndexedDB ----
  log("Listing IndexedDB databases…");
  const dbs = await indexedDB.databases();
  for (const dbInfo of dbs) {
    const dbName = dbInfo.name;
    log("Reading DB: " + dbName);

    exportObj.indexedDB[dbName] = { version: dbInfo.version, stores: {} };

    const db = await new Promise((res, rej) => {
      const r = indexedDB.open(dbName);
      r.onsuccess = e => res(e.target.result);
      r.onerror = e => rej(e.target.error);
    });

    const stores = Array.from(db.objectStoreNames);
    for (const store of stores) {
      log("  Store: " + store);

      const tx = db.transaction(store, "readonly");
      const os = tx.objectStore(store);

      const items = await new Promise((resolve) => {
        const arr = [];
        const req = os.openCursor();
        req.onsuccess = ev => {
          const cursor = ev.target.result;
          if (!cursor) return resolve(arr);
          arr.push(cursor.value);
          cursor.continue();
        };
        req.onerror = () => resolve(arr);
      });

      exportObj.indexedDB[dbName].stores[store] = items;
    }

    db.close();
  }

  log("IndexedDB read completed.");

  // ---- Package as ZIP-like blob (just JSON) ----
  const blob = new Blob([JSON.stringify(exportObj, null, 2)], {
    type: "application/octet-stream"
  });

  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "export.jqrgd";
  a.click();

  log("Export completed!");
}

// -----------------------
// Import (replace databases)
// -----------------------
async function importAll() {
  const fileInput = document.getElementById("importFile");
  if (!fileInput.files.length) {
    log("No file selected.");
    return;
  }

  const file = fileInput.files[0];

  if (!file.name.endsWith(".jqrgd")) {
    log("Invalid file type.");
    return;
  }

  log("Reading import file…");
  const text = await file.text();
  let data;
  try {
    data = JSON.parse(text);
  } catch {
    log("ERROR: File is not valid JSON.");
    return;
  }

  // ---- Restore LocalStorage ----
  log("Restoring localStorage…");
  localStorage.clear();
  for (const k in data.localStorage) {
    localStorage.setItem(k, data.localStorage[k]);
  }
  log("localStorage restored.");

  // ---- Restore IndexedDB ----
  log("Restoring IndexedDB…");
  const dbs = data.indexedDB;

  for (const dbName in dbs) {
    const dbData = dbs[dbName];
    log("Rebuilding DB: " + dbName);

    // Delete old DB
    await new Promise((res) => {
      const req = indexedDB.deleteDatabase(dbName);
      req.onsuccess = () => res();
      req.onerror = () => res();
      req.onblocked = () => res();
    });

    log("  Deleted old DB.");

    // Create DB fresh
    const db = await new Promise((res, rej) => {
      const req = indexedDB.open(dbName, dbData.version);
      req.onupgradeneeded = e => {
        const dbc = e.target.result;
        for (const storeName in dbData.stores) {
          if (!dbc.objectStoreNames.contains(storeName)) {
            dbc.createObjectStore(storeName, { autoIncrement: true });
          }
        }
      };
      req.onsuccess = e => res(e.target.result);
      req.onerror = e => rej(e.target.error);
    });

    // Insert data
    for (const storeName in dbData.stores) {
      const items = dbData.stores[storeName];
      log(`  Inserting ${items.length} items into ${storeName}`);

      const tx = db.transaction(storeName, "readwrite");
      const os = tx.objectStore(storeName);
      for (const item of items) os.add(item);

      await new Promise(res => tx.oncomplete = res);
    }

    db.close();
    log("  DB restored successfully.");
  }

  log("IMPORT COMPLETED!");
}

// -----------------------
// Button bindings
// -----------------------
document.getElementById("exportBtn").onclick = exportAll;
document.getElementById("importBtn").onclick = importAll;
</script>

</body>
</html>
