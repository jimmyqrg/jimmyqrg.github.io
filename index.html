/* =====================================================
    === GLOBAL OPEN GAME FUNCTION (available immediately) ===
    ===================================================== */

// Create the function immediately so it's available before DOM loads
(function() {
  // Default openGame function if it doesn't exist
  if (typeof window.openGame !== 'function') {
    window.openGame = function(url) {
      if (!url) return;
      
      // Get user's preferred open type
      const openType = localStorage.getItem("openGameType") || "popup";
      const target = "https://proxy.ikunbeautiful.workers.dev/?content=" + encodeURIComponent(url) + "&url=https://spicy.jimmyqrg.com/loader.html";
      
      if (openType === "newtab") {
        // Open in new tab
        const win = window.open(target, "_blank");
        
        if (!win) {
          alert("Please enable popups to open the game.");
          return;
        }
      } else {
        // Default: open in popup
        const popupFeatures = [
          "popup=yes",
          "toolbar=no",
          "location=no",
          "menubar=no",
          "status=no",
          "scrollbars=yes",
          "resizable=yes",
          "width=900",
          "height=600",
          "left=" + (window.screenX + 80),
          "top=" + (window.screenY + 60)
        ].join(",");
        
        const win = window.open(target, "_blank", popupFeatures);
        
        // If popup blocked
        if (!win) {
          alert("Please enable popups to open the game.");
          return;
        }
      }
    };
  }
})();

/* =====================================================
    === DOM INITIALIZATION ==============================
    ===================================================== */

document.addEventListener("DOMContentLoaded", () => {
  console.log("openGame.js: DOM loaded, initializing...");
  
  /* =====================================================
      === OPEN GAME TYPE SETTING ==========================
      ===================================================== */
  const OPEN_GAME_TYPE_KEY = "openGameType";
  const openGameTypeSelect = document.getElementById("openGameType");
  
  if (openGameTypeSelect) {
    console.log("Found openGameTypeSelect, setting up...");
    
    // Load saved type (default: popup)
    const savedType = localStorage.getItem(OPEN_GAME_TYPE_KEY) || "popup";
    openGameTypeSelect.value = savedType;
    console.log("Loaded open game type:", savedType);
    
    // Save on change
    openGameTypeSelect.addEventListener("change", () => {
      localStorage.setItem(OPEN_GAME_TYPE_KEY, openGameTypeSelect.value);
      console.log("Saved open game type:", openGameTypeSelect.value);
    });
  } else {
    console.warn("openGameTypeSelect element not found!");
  }
  
  /* =====================================================
      === TAB CLOAK SYSTEM ================================
      ===================================================== */
  const CLOAK_TITLE_KEY = "cloakTitle";
  const CLOAK_ICON_KEY = "cloakIcon";
  
  const cloakTitleInput = document.getElementById("cloakTitle");
  const iconOptions = document.querySelectorAll(".cloakIconOption");
  const customLabel = document.getElementById("customCloakLabel");
  const customInput = document.getElementById("customCloakInput");
  
  if (cloakTitleInput && customLabel && customInput) {
    console.log("Found cloak elements, setting up...");
    
    // Load saved data
    const savedTitle = localStorage.getItem(CLOAK_TITLE_KEY) || "";
    const savedIcon = localStorage.getItem(CLOAK_ICON_KEY) || "";
    
    cloakTitleInput.value = savedTitle;
    
    function highlightIcon(src) {
      iconOptions.forEach(i => i.classList.remove("active"));
      customLabel.classList.remove("active");
      
      let found = false;
      iconOptions.forEach(i => {
        if (i.dataset.src === src) {
          i.classList.add("active");
          found = true;
        }
      });
      
      if (!found && src) customLabel.classList.add("active");
    }
    
    highlightIcon(savedIcon);
    
    // Save title changes
    cloakTitleInput.addEventListener("input", () => {
      localStorage.setItem(CLOAK_TITLE_KEY, cloakTitleInput.value);
    });
    
    // Choose preset icon
    iconOptions.forEach(img => {
      img.addEventListener("click", () => {
        const src = img.dataset.src;
        localStorage.setItem(CLOAK_ICON_KEY, src);
        highlightIcon(src);
      });
    });
    
    // Custom upload
    customLabel.addEventListener("click", () => customInput.click());
    customInput.addEventListener("change", e => {
      const file = e.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = e => {
        const dataURL = e.target.result;
        localStorage.setItem(CLOAK_ICON_KEY, dataURL);
        highlightIcon(dataURL);
      };
      reader.readAsDataURL(file);
    });
    
    // Drag & drop custom icon
    customLabel.addEventListener("dragover", e => { 
      e.preventDefault(); 
      customLabel.style.opacity = 0.7; 
    });
    customLabel.addEventListener("dragleave", () => { 
      customLabel.style.opacity = 1; 
    });
    customLabel.addEventListener("drop", e => {
      e.preventDefault();
      customLabel.style.opacity = 1;
      
      const file = e.dataTransfer.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = e => {
        const dataURL = e.target.result;
        localStorage.setItem(CLOAK_ICON_KEY, dataURL);
        highlightIcon(dataURL);
      };
      reader.readAsDataURL(file);
    });
  } else {
    console.warn("Cloak UI elements not found. Skipping tab cloak initialization.");
  }
  
  /* =====================================================
      === APPLY TAB CLOAK IMMEDIATELY =====================
      ===================================================== */
  
  // Apply cloak immediately when page loads
  function applyTabCloak() {
    const savedTitle = localStorage.getItem(CLOAK_TITLE_KEY);
    const savedIcon = localStorage.getItem(CLOAK_ICON_KEY);
    
    if (savedTitle) {
      document.title = savedTitle;
    }
    
    if (savedIcon) {
      const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
      link.type = 'image/x-icon';
      link.rel = 'shortcut icon';
      link.href = savedIcon;
      document.getElementsByTagName('head')[0].appendChild(link);
    }
  }
  
  // Apply cloak on page load
  applyTabCloak();
  
  // Also apply cloak whenever settings change
  if (cloakTitleInput) {
    cloakTitleInput.addEventListener("input", applyTabCloak);
  }
  
  // Listen for icon changes
  const observer = new MutationObserver(() => {
    const savedIcon = localStorage.getItem(CLOAK_ICON_KEY);
    if (savedIcon) {
      const link = document.querySelector("link[rel*='icon']") || document.createElement('link');
      link.type = 'image/x-icon';
      link.rel = 'shortcut icon';
      link.href = savedIcon;
      document.getElementsByTagName('head')[0].appendChild(link);
    }
  });
  
  // Observe localStorage changes for icon
  window.addEventListener('storage', (e) => {
    if (e.key === CLOAK_ICON_KEY) {
      applyTabCloak();
    }
  });
  
  console.log("openGame.js initialization complete!");
});

/* =====================================================
    === TAB CLOAK APPLICATION (also works before DOM) ====
    ===================================================== */

// Apply cloak even before DOM is ready
(function applyCloakImmediately() {
  const savedTitle = localStorage.getItem("cloakTitle");
  const savedIcon = localStorage.getItem("cloakIcon");
  
  if (savedTitle && document.title !== savedTitle) {
    document.title = savedTitle;
  }
  
  if (savedIcon) {
    // Check if we already have a favicon
    let link = document.querySelector("link[rel*='icon']");
    if (!link) {
      link = document.createElement('link');
      link.rel = 'shortcut icon';
      document.head.appendChild(link);
    }
    link.href = savedIcon;
  }
})();
