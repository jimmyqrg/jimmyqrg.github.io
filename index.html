<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="js/panicKey.js"></script>
    <script src="js/mainPageCloak.js"></script>

    <script>
      // Load current domain early
      let currentDomain = "jimmyqrg.github.io"; // Default fallback
      (async function () {
        try {
          const response = await fetch("/currentDomain.txt");
          currentDomain = (await response.text()).trim();
        } catch (error) {
          console.error("Failed to load currentDomain.txt, using fallback");
        }
      })();
    </script>

    <script>
      (function () {
        const currentUrl = window.location.href;
        const urlParams = new URLSearchParams(window.location.search);
        const pageParam = urlParams.get('page');

        // Skip all redirects if any URL parameter value is "1"
        const hasDirectAccess = Array.from(urlParams.values()).includes("1");
        if (hasDirectAccess) return;

        // Check if URL does not include "page"
        if (!currentUrl.includes("page")) {
          window.location.href = "page/";
          return;
        }

        // Check if current page is not iframed in
        if (window.self === window.top) {
          window.location.href = "page/";
          return;
        }

        // Check if ?page=extend is not present
        if (!pageParam || pageParam !== "extend") {
          window.location.href = "?page=extend";
          return;
        }
      })();
    </script>
    <script src="/js/openGame.js"></script>
    <script src="/js/updateDomainUrls.js"></script>
    <link rel="stylesheet" href="/css/main.css" />
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#4d8cff" />
    <!-- iOS PWA support -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="JimmyQrg" />
    <link rel="apple-touch-icon" href="/game-images/games/jq.png" />
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Home | JQRG</title>
    <link rel="icon" type="image/png" href="jq.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Oxanium:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Josefin+Sans:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="js/style.js"></script>
    <script src="js/cursor.js"></script>
  </head>
  <body>
    <div class="bg-effects"></div>
    <span id="settingsBtn">‚öôÔ∏è</span>

    <h1 id="domainTitle" class="page-title">JIMMYQRG</h1>

    <h2 class="page-title">MAIN PORTAL</h2>

    <div class="blocks-container">
      <a href="jqrg-games/" class="block-link">
        <div class="block">
          <div class="block-icon">
            <i class="fas fa-gamepad"></i>
          </div>
          <div class="block-text">JQRG UNBLOCKED GAMES</div>
        </div>
      </a>
      <a href="https://jimmyqrg.github.io/info" class="block-link">
        <div class="block">
          <div class="block-icon">
            <i class="fas fa-circle-info"></i>
          </div>
          <div class="block-text">INTERESTING INFOS</div>
        </div>
      </a>
      <a href="https://jimmyqrg.github.io/tools/" class="block-link">
        <div class="block">
          <div class="block-icon">
            <i class="fas fa-wrench"></i>
          </div>
          <div class="block-text">TOOLS</div>
        </div>
      </a>
      <a href="unblocks/" class="block-link">
        <div class="block">
          <div class="block-icon">
            <i class="fas fa-unlock"></i>
          </div>
          <div class="block-text">OTHER UNBLOCKS</div>
        </div>
      </a>
      <a href="lx/" class="block-link">
        <div class="block">
          <div class="block-icon">
            <i class="fas fa-phone"></i>
          </div>
          <div class="block-text">CONTACTS</div>
        </div>
      </a>
      <a href="test/jqrgd.html" class="block-link">
        <div class="block">
          <div class="block-icon">
            <i class="fas fa-flask"></i>
          </div>
          <div class="block-text">JQRGD TEST</div>
        </div>
      </a>
      <!-- PWA Install Block -->
      <div class="block-link" id="installAppBtn" style="display: none; cursor: pointer;">
        <div class="block install-block">
          <div class="block-icon">
            <i class="fas fa-download"></i>
          </div>
          <div class="block-text">INSTALL APP</div>
        </div>
      </div>
    </div>

    <!-- PWA Install Status -->
    <p id="installStatus" style="display: none; text-align: center; padding: 10px 20px; margin: 10px auto; max-width: 500px; border-radius: 10px; background: rgba(0,0,0,0.3);"></p>

    <p>
      <span class="announcement-link">Announcements (Click to reopen)</span
      ><br /><br />If you want to join me and make the website together, click
      <a
        href="#"
        data-path="/join/"
        target="_blank"
        style="color: #4d8cff; text-decoration: underline"
        >here</a
      >!
    </p>

    <!-- === Footer === -->
    <footer class="site-footer">
      <div class="footer-content">
        <p class="footer-copyright">copyright ikunbeautiful@gmail.com 2026</p>
        <a href="https://www.github.com/jimmyqrg/" target="_blank" rel="noopener noreferrer" class="footer-github-link">
          <i class="fab fa-github"></i>
        </a>
      </div>
    </footer>

    <!-- === Announcement Modal === -->
    <div class="modal-overlay" id="announcementModal">
      <div class="modal-content" id="announcementContent">
        <span class="close-btn" id="closeModal">&times;</span>
        <h2 style="text-align:center;">üì¢ Announcements</h2>
      <p>Welcome to <strong>JimmyQrg</strong>! Check here for updates, new game releases, and important information.</p>
      <p>More informations and updates can be found 
        <a href="https://docs.google.com/document/d/1Xv3x76SwL2CkZPIJq0uMNBt_YQNRfWrR5H5mXILuxfw/edit?tab=t.w5htvyo8czbl" 
           target="_blank" 
           style="color:#4d8cff; text-decoration:underline;">here</a>.</p>
      <hr style="border: 1px solid rgba(255,255,255,0.3);">
      <p>‚ú® Latest updates:</p>
        <ul>
          <li>Added Tanuki Sunset</li>
        </ul>
        <!-- <p>üöÄFuture Update</p>
        <ul>
          <li></li>
        </ul> -->
      <p>‚è±Ô∏èHistory</p>
        <ul>
          <!-- <li>Fixed in total <b>753</b> bugs</li> -->
          <li>Added in total <b>87</b> games</li>
        </ul>
      </div>
    </div>

    <!-- === SETTINGS MODAL === -->
    <div class="modal-overlay" id="settingsModal">
      <div class="modal-content" id="settingsContent">
        <span class="close-btn" id="closeSettings">&times;</span>

        <h2 style="text-align: center">‚öôÔ∏è Settings</h2>

        <!-- ========== APPEARANCE ========== -->
        <h3>üé® Appearance</h3>

        <!-- Enable Cursor -->
        <label><b>Cursor</b></label><br />
        <p style="margin-top: 10px; opacity: 0.8">
          Show the custom cursor on all pages. (except in games)
        </p>
        <input
          type="checkbox"
          id="enableCursor"
          style="margin-top: 10px"
        />
        <label for="enableCursor" style="margin-left: 8px; cursor: pointer;">
          Enable cursor
        </label>

        <br /><br /><br />

        <!-- Disabled Cloak Settings -->
        
        <!-- Main Page Cloak
        <label><b>Use cloak for main page</b></label><br />
        <p style="margin-top: 10px; opacity: 0.8">
          When enabled, the main page title will show "Home | Schoology" and use the Schoology icon.<br />
          This applies to all pages except game files.
        </p>
        <input
          type="checkbox"
          id="mainPageCloak"
          style="margin-top: 10px"
        />
        <label for="mainPageCloak" style="margin-left: 8px; cursor: pointer;">
          Enable main page cloak
        </label>

        <br /><br /><br />

        Game tab cloak
        <label><b>Game tab cloak</b></label
        ><br /><br />

        Title
        <p><b>Tab Name</b></p>
        <input
          id="cloakTitle"
          type="text"
          class="styled-input"
          placeholder="Enter tab title"
          style="margin-top: 5px"
        />

        <br /><br />

        Icons
        <p><b>Tab Icon</b></p>

        <div
          id="cloakIconContainer"
          style="
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
          "
        >
          Preset icons
          <img
            class="cloakIconOption"
            data-src="https://jimmyqrg.github.io/cloak-images/default.png"
            src="cloak-images/default.png"
            draggable="false"
          />
          <img
            class="cloakIconOption"
            data-src="https://jimmyqrg.github.io/cloak-images/docs.png"
            src="cloak-images/docs.png"
            draggable="false"
          />
          <img
            class="cloakIconOption"
            data-src="https://jimmyqrg.github.io/cloak-images/drive.png"
            src="cloak-images/drive.png"
            draggable="false"
          />
          <img
            class="cloakIconOption"
            data-src="https://jimmyqrg.github.io/cloak-images/forms.png"
            src="cloak-images/forms.png"
            draggable="false"
          />
          <img
            class="cloakIconOption"
            data-src="https://jimmyqrg.github.io/cloak-images/pausd.png"
            src="cloak-images/pausd.png"
            draggable="false"
          />
          <img
            class="cloakIconOption"
            data-src="https://jimmyqrg.github.io/cloak-images/schoology.png"
            src="cloak-images/schoology.png"
            draggable="false"
          />

          Custom upload
          <label
            id="customCloakLabel"
            style="
              width: 100%;
              height: 100px;
              border: 2px dashed #aaa;
              display: flex;
              justify-content: center;
              align-items: center;
              border-radius: 10px;
              cursor: pointer;
            "
          >
            <span style="opacity: 0.6">Custom Icon</span>
            <input
              id="customCloakInput"
              type="file"
              accept="image/*"
              style="display: none"
            />
          </label>
        </div> -->

        <br />

        <hr style="border: 1px solid rgba(255,255,255,0.2); margin: 30px 0;">

        <!-- ========== GAME SETTINGS ========== -->
        <h3>üéÆ Game Settings</h3>

        <!-- Open Game Type -->
        <label><b>Open Game Type</b></label><br />
        <p style="margin-top: 10px; opacity: 0.8">
          Choose how games open when you click on them.
        </p>
        <select
          id="openGameType"
          class="styled-select"
          style="margin-top: 8px"
        >
          <option value="popup">Popup Window</option>
          <option value="newtab">New Tab</option>
        </select>

        <br /><br /><br />

        <!-- Open in popup -->
        <label><b>Open the website in loader mode</b></label>
        <button
          class="btn"
          onclick="openGame('https://pausd.schooloqy.com/?page=extend')"
        >
          OPEN
        </button>

        <hr style="border: 1px solid rgba(255,255,255,0.2); margin: 30px 0;">

        <!-- ========== ANNOUNCEMENTS ========== -->
        <h3>üì¢ Announcements</h3>

        <!-- Auto popup setting -->
        <label><b>Auto pop up announcements:</b></label
        ><br />
        <select
          id="announcementSetting"
          class="styled-select"
          style="margin-top: 8px"
        >
          <option value="always">Always</option>
          <option value="big">Only when there is a big announcement</option>
        </select>

        <hr style="border: 1px solid rgba(255,255,255,0.2); margin: 30px 0;">

        <!-- ========== SECURITY & EMERGENCY ========== -->
        <h3>üîí Security & Emergency</h3>

        <!-- Panic Key -->
        <label><b>Panic Key</b></label
        ><br />
        <p style="margin-top: 10px; opacity: 0.8">
          A key that auto-redirect to an website right when you press it. This
          will exit the website immediately in an emergency.<br /><br />THIS
          WORKS IN PAGES ONLY, NOT IN GAMES.<br />
        </p>
        <p>Customize key</p>
        <button id="panicKeyBtn" class="btn customizeKey"></button><br />
        <p>Customize website</p>
        <input
          type="text"
          id="panicLinkInput"
          class="styled-input"
          style="margin-top: 5px"
          placeholder="https://example.com"
        />
        <br /><br /><br />

        <!-- Access code -->
        <label><b>Access code:</b></label>
        <p style="margin-top: 10px; opacity: 0.8">
          For interaction in construction zone
        </p>
        <input
          id="accessCode"
          type="password"
          class="styled-input"
          placeholder="Enter code"
          style="margin-top: 5px"
        />
        <button id="authorizeBtn" class="btn" style="margin-top: 15px">
          AUTHORIZE
        </button>
        <button id="unauthorizeBtn" class="btn" style="margin-top: 10px">
          UNAUTHORIZE
        </button>

        <hr style="border: 1px solid rgba(255,255,255,0.2); margin: 30px 0;">

        <!-- Lisence -->
        <label><b>Lisence</b></label>
        <p style="margin-top: 10px;">
          All rights held by <b>ikunbeautiful@gmail.com</b><br />No part of this
          website may be copied, reused, redistributed, modified, or
          commercially exploited
          <b>without prior written permission from the owner</b>.
        </p>
      </div>
    </div>

    <script>
      /* --- Big Announcement flag --- */

      let hasBigAnnouncement = false;

      // Wait for DOM to be ready
      document.addEventListener("DOMContentLoaded", function () {
        // Update all URLs with domain from currentDomain.txt
        (async function () {
          try {
            const response = await fetch("/currentDomain.txt");
            const domain = (await response.text()).trim();
            currentDomain = domain;

            // Update all links with data-path attribute
            document.querySelectorAll("a[data-path]").forEach((link) => {
              const path = link.getAttribute("data-path");
              link.href = `https://${domain}${path}`;
            });

            // Update all cloak icon images with data-src attribute (for tab cloak settings)
            document
              .querySelectorAll("img.cloakIconOption[data-src]")
              .forEach((img) => {
                const dataSrc = img.getAttribute("data-src");
                if (dataSrc && dataSrc.includes("jimmyqrg.github.io")) {
                  img.setAttribute(
                    "data-src",
                    dataSrc.replace(
                      /https?:\/\/teacher\.jimmyqrg\.com/g,
                      `https://${domain}`
                    )
                  );
                }
              });

            // Update currentDomainCache for panicKey.js
            if (typeof window !== "undefined") {
              window.currentDomainCache = domain;
            }
          } catch (error) {
            console.error("Failed to load currentDomain.txt, using fallback");
          }
        })();

        if ("serviceWorker" in navigator) {
          navigator.serviceWorker
            .register("/sw.js", { scope: "/" })
            .then((registration) => {
              console.log("Service Worker registered with scope:", registration.scope);
              // Check for updates
              registration.addEventListener('updatefound', () => {
                console.log('Service Worker update found');
              });
            })
            .catch((err) =>
              console.error("Service Worker registration failed:", err)
            );
        }

        /* --- Announcement Modal Controls --- */
        const modal = document.getElementById("announcementModal");
        const content = document.getElementById("announcementContent");
        const openBtn = document.querySelector(".announcement-link");
        const closeBtn = document.getElementById("closeModal");

        let isAnnouncementModalOpen = false;
        let isAnnouncementModalAnimating = false;

        function openModal() {
          if (isAnnouncementModalOpen || isAnnouncementModalAnimating) return;
          isAnnouncementModalAnimating = true;
          isAnnouncementModalOpen = true;
          
          modal.classList.remove("hide");
          content.classList.remove("hide");
          modal.style.display = "flex";
          setTimeout(() => {
            modal.classList.add("show");
            content.classList.add("show", "active");
            isAnnouncementModalAnimating = false;
          }, 10);
        }

        function closeModal() {
          if (!isAnnouncementModalOpen || isAnnouncementModalAnimating) return;
          isAnnouncementModalAnimating = true;
          
          modal.classList.remove("show");
          content.classList.remove("show", "active");
          content.classList.add("hide");
          modal.classList.add("hide");
          setTimeout(() => {
            modal.style.display = "none";
            content.classList.remove("hide");
            isAnnouncementModalOpen = false;
            isAnnouncementModalAnimating = false;
          }, 400);
        }

        /* === Auto Popup Logic === */
        const autoSetting =
          localStorage.getItem("autoAnnouncement") || "always";

        if (autoSetting === "always") {
          window.addEventListener("load", openModal);
        } else if (autoSetting === "big" && hasBigAnnouncement) {
          window.addEventListener("load", openModal);
        }

        openBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          openModal();
        });
        
        closeBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          closeModal();
        });

        content.addEventListener("click", (e) => {
          e.stopPropagation();
        });

        window.addEventListener("click", (e) => {
          if (e.target === modal && !isAnnouncementModalAnimating) {
            closeModal();
          }
        });

        /* === SETTINGS MODAL === */
        const settingsBtn = document.getElementById("settingsBtn");
        const settingsModal = document.getElementById("settingsModal");
        const settingsContent = document.getElementById("settingsContent");
        const closeSettings = document.getElementById("closeSettings");

        let isSettingsModalOpen = false;
        let isSettingsModalAnimating = false;

        function openSettingsModal() {
          if (isSettingsModalOpen || isSettingsModalAnimating) return;
          isSettingsModalAnimating = true;
          isSettingsModalOpen = true;
          
          settingsModal.classList.remove("hide");
          settingsContent.classList.remove("hide");
          settingsModal.style.display = "flex";
          setTimeout(() => {
            settingsModal.classList.add("show");
            settingsContent.classList.add("show", "active");
            isSettingsModalAnimating = false;
          }, 10);
        }

        function closeSettingsModal() {
          if (!isSettingsModalOpen || isSettingsModalAnimating) return;
          isSettingsModalAnimating = true;
          
          settingsModal.classList.remove("show");
          settingsContent.classList.remove("show", "active");
          settingsContent.classList.add("hide");
          settingsModal.classList.add("hide");
          setTimeout(() => {
            settingsModal.style.display = "none";
            settingsContent.classList.remove("hide");
            isSettingsModalOpen = false;
            isSettingsModalAnimating = false;
          }, 400);
        }

        settingsBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (isSettingsModalOpen) {
            closeSettingsModal();
          } else {
            openSettingsModal();
          }
        });

        closeSettings.addEventListener("click", (e) => {
          e.stopPropagation();
          closeSettingsModal();
        });

        settingsContent.addEventListener("click", (e) => {
          e.stopPropagation();
        });

        window.addEventListener("click", (e) => {
          if (e.target === settingsModal && !isSettingsModalAnimating) {
            closeSettingsModal();
          }
        });

        /* === SETTINGS FUNCTIONALITY === */
        const announcementSetting = document.getElementById(
          "announcementSetting"
        );
        announcementSetting.value = autoSetting;

        announcementSetting.addEventListener("change", () => {
          localStorage.setItem("autoAnnouncement", announcementSetting.value);
        });


        /* === Main Page Cloak Setting === */
        const mainPageCloakCheckbox = document.getElementById("mainPageCloak");
        const mainPageCloakEnabled = localStorage.getItem("mainPageCloak") === "true";
        if (mainPageCloakCheckbox) {
          mainPageCloakCheckbox.checked = mainPageCloakEnabled;
          mainPageCloakCheckbox.addEventListener("change", () => {
            localStorage.setItem("mainPageCloak", mainPageCloakCheckbox.checked ? "true" : "false");
            // Reload page to apply changes
            window.location.reload();
          });
        }

        /* --- Access Code System --- */
        const authorizeBtn = document.getElementById("authorizeBtn");
        const unauthorizeBtn = document.getElementById("unauthorizeBtn");

        authorizeBtn.addEventListener("click", () => {
          const code = document.getElementById("accessCode").value;
          if (code === "asdfghjkl;'") {
            localStorage.setItem("user", "authorized");
            alert("Access granted.");
          } else {
            alert("Incorrect code.");
          }
        });

        unauthorizeBtn.addEventListener("click", () => {
          localStorage.setItem("user", "normal");
          alert("User unauthorized.");
        });

        // ---------- Persistent Panic Key Logic ----------
        const PANIC_KEY_STORAGE = "panicKey";
        const PANIC_LINK_STORAGE = "panicKeyLink";

        // Default: Right Shift
        let panicKey = localStorage.getItem(PANIC_KEY_STORAGE) || "ShiftRight";
        let isRecording = false;
        let previousKey = panicKey;

        const customizeKey = document.getElementById("panicKeyBtn");
        const linkInput = document.getElementById("panicLinkInput");

        // Display current key
        customizeKey.textContent = panicKey;

        // Load saved link
        linkInput.value = localStorage.getItem(PANIC_LINK_STORAGE) || "https://pausd.schoology.com";

        // Save link on input
        linkInput.addEventListener("input", () => {
          localStorage.setItem(PANIC_LINK_STORAGE, linkInput.value);
        });

        // Start listening for key press
        customizeKey.addEventListener("click", (e) => {
          e.stopPropagation();
          if (isRecording) return;

          isRecording = true;
          previousKey = panicKey;

          customizeKey.textContent = ""; // blank for recording
          customizeKey.style.opacity = "0.6";
        });

        // Key recorder
        document.addEventListener(
          "keydown",
          (e) => {
            if (!isRecording) return;

            // Stop this event from triggering the redirect listener
            e.stopImmediatePropagation();

            panicKey = e.code;
            localStorage.setItem(PANIC_KEY_STORAGE, panicKey);

            customizeKey.textContent = panicKey;
            customizeKey.style.opacity = "1";
            isRecording = false;
          },
          true
        ); // Use capture phase to ensure it runs first

        // Cancel recording on outside click
        document.addEventListener("click", () => {
          if (!isRecording) return;

          // Restore the old key
          customizeKey.textContent = previousKey;
          customizeKey.style.opacity = "1";
          isRecording = false;
        });

        // Function to fix/normalize redirect links
        function fixRedirectLink(link) {
          if (!link) return "https://pausd.schoology.com";

          // If it's already a full URL with protocol, use it as is
          if (link.startsWith("http://") || link.startsWith("https://")) {
            return link;
          }

          // If it starts with a path (e.g., "jqrg-games/eaglercraft")
          // or is a relative path, prepend the base URL
          if (link.startsWith("/") || link.includes("/")) {
            // Remove leading slash if present
            const cleanPath = link.startsWith("/") ? link.substring(1) : link;
            const domain = currentDomain || "jimmyqrg.github.io";
            return `https://${domain}/${cleanPath}`;
          }

          // If it's just a domain (e.g., "www.schooloqy.com"), add protocol
          if (link.includes(".") && !link.includes("/")) {
            return `https://${link}`;
          }

          // Default fallback
          return "https://pausd.schoology.com";
        }

        // Listen for panic key press to redirect
        document.addEventListener("keydown", (e) => {
          // Don't trigger redirect while recording a new key
          if (isRecording) return;

          // Always check localStorage directly to get the latest values
          const currentPanicKey =
            localStorage.getItem(PANIC_KEY_STORAGE) || "ShiftRight";
          const currentPanicLink =
            localStorage.getItem(PANIC_LINK_STORAGE) || "";

          // Fix the redirect link if it's incorrect
          const redirectLink = fixRedirectLink(currentPanicLink);

          // Match the key code (e.code)
          if (e.code === currentPanicKey) {
            // Immediately redirect
            window.location.href = redirectLink;
          }
        });

        // === PWA Install Button ===
        let deferredPrompt = null;
        let installBtnListenerAdded = false;
        const installAppBtn = document.getElementById("installAppBtn");
        const installStatus = document.getElementById("installStatus");

        // Function to handle install button click
        async function handleInstallClick() {
          if (!deferredPrompt) {
            if (installStatus) {
              installStatus.textContent =
                "Install prompt not available. Please use your browser's menu to install.";
              installStatus.style.display = "block";
              installStatus.style.color = "#ff4d4d";
            }
            return;
          }

          // Show the install prompt
          deferredPrompt.prompt();

          // Wait for the user to respond
          const { outcome } = await deferredPrompt.userChoice;

          if (outcome === "accepted") {
            if (installStatus) {
              installStatus.textContent = "‚úì Installation started!";
              installStatus.style.display = "block";
              installStatus.style.color = "#4dff4d";
            }
          } else {
            if (installStatus) {
              installStatus.textContent = "Installation cancelled.";
              installStatus.style.display = "block";
              installStatus.style.color = "#ffaa4d";
            }
          }

          // Clear the deferred prompt and hide button
          deferredPrompt = null;
          if (installAppBtn) installAppBtn.style.display = "none";
        }

        // Check if app is already installed
        function checkIfInstalled() {
          // Check if running in standalone mode (installed)
          if (
            window.matchMedia("(display-mode: standalone)").matches ||
            window.navigator.standalone === true
          ) {
            if (installStatus) {
              installStatus.textContent = "‚úì App is already installed";
              installStatus.style.display = "block";
              installStatus.style.color = "#4dff4d";
            }
            if (installAppBtn) installAppBtn.style.display = "none";
            return true;
          }
          return false;
        }

        // Check on load
        if (checkIfInstalled()) {
          // App is already installed
        } else {
          // Listen for the beforeinstallprompt event
          window.addEventListener("beforeinstallprompt", (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button
            if (installAppBtn) installAppBtn.style.display = "block";
            if (installStatus) installStatus.style.display = "none";

            // Add click listener only once
            if (!installBtnListenerAdded) {
              installBtnListenerAdded = true;

              if (installAppBtn) {
                installAppBtn.addEventListener("click", handleInstallClick);
              }
            }
          });

          // Handle app installed event (fires after installation)
          window.addEventListener("appinstalled", () => {
            if (installStatus) {
              installStatus.textContent = "‚úì App installed successfully!";
              installStatus.style.display = "block";
              installStatus.style.color = "#4dff4d";
            }
            if (installAppBtn) installAppBtn.style.display = "none";
            deferredPrompt = null;
          });

          // Fallback instructions if prompt doesn't appear
          setTimeout(() => {
            if (
              !deferredPrompt &&
              installAppBtn &&
              installAppBtn.style.display !== "none"
            ) {
              const isMobile =
                /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(
                  navigator.userAgent
                );
              if (installStatus) {
                if (isMobile) {
                  installStatus.textContent =
                    'Use your browser menu (‚ãÆ or ‚ãØ) and select "Add to Home Screen" or "Install App"';
                } else {
                  installStatus.textContent =
                    'Use your browser menu (‚ãÆ) and select "Install [App Name]"';
                }
                installStatus.style.display = "block";
                installStatus.style.color = "#ffaa4d";
              }
            }
          }, 2000);
        }
      }); // End DOMContentLoaded
    </script>
  </body>
</html>
